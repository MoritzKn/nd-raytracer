!function(t){var e={};function s(a){if(e[a])return e[a].exports;var i=e[a]={i:a,l:!1,exports:{}};return t[a].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=t,s.c=e,s.d=function(t,e,a){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)s.d(a,i,function(e){return t[e]}.bind(null,i));return a},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class a{constructor(t){let e=6;navigator.hardwareConcurrency&&(e=navigator.hardwareConcurrency),this.pool=[];for(var s=0;s<e;s++){const e=new Worker(t);e.jobs=0,this.pool.push(e)}this.msgId=0,this.pending=[],console.log(`Created ${e} workers`)}size(){return this.pool.length}broadcast(t,e){return Promise.all(this.pool.map(s=>this.send(s,t,e)))}send(t,e,s){this.msgId+=1;const a=this.msgId;let i=[];return s&&s.data&&s.data.buffer&&i.push(s.data.buffer),t.jobs+=1,t.postMessage({type:e,data:s,id:a},i),new Promise((e,s)=>{const i=n=>{const{type:r,id:o,data:h,error:c}=n.data;o===a&&(t.removeEventListener("message",i),t.jobs-=1,this.runPendingJobs(),c?s(c):e(h))};t.addEventListener("message",i)})}runPendingJobs(){this.pool.forEach(t=>{if(0===t.jobs&&this.pending.length>0){const e=this.pending.pop();this.send(t,e.type,e.data).then(e.resolve,e.reject)}})}schedule(t,e){let s,a;const i=new Promise((function(t,e){s=t,a=e}));return this.pending.push({type:t,data:e,resolve:s,reject:a}),this.runPendingJobs(),i}}class i{constructor(){this.targetDt=1e3/24,this.dt=this.targetDt,this.avgDt=null,this.frameStart=null,this.lastReset=0}start(){this.frameStart=performance.now()}end(){this.dt=performance.now()-this.frameStart,null!==this.avgDt?this.avgDt=(30*this.avgDt+this.dt)/31:this.lastReset>0&&(this.avgDt=this.dt),this.lastReset+=1}differenceTarget(){return null!==this.avgDt?this.targetDt/this.avgDt:1}onTarget(){let t;t=this.lastReset<30?.5:.2;return Math.abs(1-this.differenceTarget())<t}resetAvg(){this.avgDt=null,this.lastReset=0}dtSec(t){return this.dt/1e3/t}toString(){const t=this.avgDt||this.dt;return`${this.dt.toFixed(2)}ms (avg: ${t.toFixed(2)}ms)`}}const n=2*Math.PI;function r(t,e){return[Math.cos(t)*e,Math.sin(t)*e]}const o=new class{constructor(){this.canvas=document.getElementById("canvas"),this.ctx=canvas.getContext("2d"),this.workerPool=new a("worker.js"),this.dt=new i,this.camPos=[-6,0,-2,0,1,1],this.dimension=4,this.scale=1,this.currentFrame=null,this.paused=!0;let t=null,e=null;window.addEventListener("resize",async()=>{await e,clearTimeout(t),t=setTimeout(()=>{e=this.stop().then(()=>{this.resize(),this.resume()})},50)}),this.resize()}async start(t){this.paused=!1,t&&(this.dimension=t),await this.workerPool.broadcast("start",{dimension:this.dimension}),this.dt.resetAvg(),this.currentFrame=this.draw()}async stop(){this.paused=!0,await this.currentFrame}resume(){this.paused=!1,this.currentFrame=this.draw()}async draw(){if(!this.dt.onTarget()){let t=Math.sqrt(this.dt.differenceTarget());const e=Math.min(Math.max(this.scale*t,.1),2);await this.resize(e)}this.dt.start();let t=Math.atan2(this.camPos[1],this.camPos[0]),e=Math.atan2(this.camPos[3],this.camPos[2]),s=Math.atan2(this.camPos[5],this.camPos[4]);this.camPos=[...r(t+n*this.dt.dtSec(12),8),...r(e+n*this.dt.dtSec(6),2),...r(s+n*this.dt.dtSec(5),6)];let a=2*this.workerPool.size(),i=[],o=27*Math.ceil(this.canvas.height/a/27);for(var h=0;h<a;h++){let t=o*h,e=Math.min(t+o,this.canvas.height),s=this.ctx.getImageData(0,t,this.canvas.width,e);i.push(this.workerPool.schedule("update",{data:s.data,camPos:this.camPos,start:t,end:e,width:this.canvas.width,height:this.canvas.height,dimension:this.dimension}))}const c=await Promise.all(i);this.dt.end(),await new Promise(t=>{requestAnimationFrame(t)}),c.forEach((t,e)=>{const s=new ImageData(t,this.canvas.width);this.ctx.putImageData(s,0,o*e)}),console.log(`update dt: ${this.dt}, scale: ${this.scale.toFixed(2)}`),this.paused||(this.currentFrame=this.draw())}resize(t){if(t){if(t===this.scale)return;this.scale=t}const e=document.getElementById("wrapper"),s=27*Math.ceil(e.clientWidth*this.scale/27),a=27*Math.ceil(e.clientHeight*this.scale/27);let i=Math.max(e.clientWidth/s,e.clientHeight/a);this.canvas.style.transform=`scale(${Math.max(i+.01,1)})`,this.canvas.style.transformOrigin="center",this.canvas.width=s,this.canvas.height=a,this.dt.resetAvg(),console.log(`rescale: ${this.scale.toFixed(2)}, canvas: ${s} ${a}`)}};o.start(4),document.getElementById("dimension").addEventListener("change",async t=>{const e=Math.max(Math.min(parseInt(t.target.value,10),9),2);document.getElementById("dimension").value=e,await o.stop(),await o.start(e)})}]);