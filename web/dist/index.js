!function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t){let e=8;navigator.hardwareConcurrency&&(e=navigator.hardwareConcurrency);const s=this.onMessage.bind(this);this.pool=[];for(let i=0;i<e;i++){const e=new Worker(t,{name:`pool[${i}]`});e.jobs=0,this.pool.push(e),e.addEventListener("message",s)}this.msgId=0,this.pending=[],this.sent=[],console.log(`Created ${e} workers`)}onMessage(t){this.pending.length>0&&this.runPendingJobs();const e=this.sent,s=e.length,i=t.data.id;for(let n=0;n<s;n++){const s=e[n];if(s.id===i)return s.worker.jobs-=1,void(t.data.error?s.reject(t.data.error):s.resolve(t.data.data))}}size(){return this.pool.length}broadcast(t,e){return Promise.all(this.pool.map(s=>this.send(s,t,e)))}send(t,e,s){return new Promise((i,n)=>{this.sendInternal(t,e,s,i,n)})}sendInternal(t,e,s,i,n){const a=this.msgId;let r=void 0;s&&s.data&&s.data.buffer&&(r=[s.data.buffer]),t.postMessage({type:e,data:s,id:a},r),this.sent.push({worker:t,id:a,resolve:i,reject:n}),this.msgId+=1,t.jobs+=1}runPendingJobs(){const t=this.pool,e=t.length;for(let s=0;s<e;s++){let e=t[s];if(!(this.pending.length>0))return;if(e.jobs<1){const t=this.pending.shift();this.sendInternal(e,t.type,t.data,t.resolve,t.reject)}}if(this.pending.length>this.size())for(let s=0;s<e;s++){let e=t[s];if(!(this.pending.length>0))return;if(e.jobs<2){const t=this.pending.shift();this.sendInternal(e,t.type,t.data,t.resolve,t.reject)}}}schedule(t,e){let s,i;const n=new Promise((function(t,e){s=t,i=e}));return this.pending.push({type:t,data:e,resolve:s,reject:i}),this.runPendingJobs(),n}}class n{constructor(){this.frameStart=null,this.dt=50,this.fps=20,this.frameCounter=0,this.secondStart=null}start(){const t=performance.now();this.frameStart=t,null===this.secondStart&&(this.secondStart=t),t-this.secondStart>1e3&&(this.fps=this.frameCounter,this.frameCounter=0,this.secondStart=t)}end(){const t=performance.now();this.dt=t-this.frameStart,this.frameCounter+=1}differenceTarget(){return this.fps/20}onTarget(){return Math.abs(1-this.differenceTarget())<.3}reset(){this.fps=20}dtSec(t){return this.dt/1e3/t}toString(){return`${this.dt.toFixed(2)}ms (${this.fps} fps)`}}const a=document.getElementById("dimension"),r=document.getElementById("scene"),o=document.getElementById("stats"),h=2*Math.PI,c=[];function d(t,e,s,i,n=0){e-=n;const a=c[t]||(Math.random()<.5?1:-1);c[t]=a;const r=.5*s;(e+=a*s*i)>r&&(e=r-(e-r),c[t]=-a);const o=-.5*s;return e<o&&(e=o-(e-o),c[t]=-a),e+=n}const l=new class{constructor(){this.canvas=document.getElementById("canvas"),this.ctx=canvas.getContext("2d"),this.workerPool=new i("worker.js"),this.dt=new n,this.camPos=[8,8,6,8,-3,-2,-1,0,1,2,3,4],this.dimension=4,this.scene="inital",this.scale=1,this.imageData=[],this.currentFrame=null,this.paused=!0;let t=null,e=null;window.addEventListener("resize",async()=>{await e,clearTimeout(t),t=setTimeout(()=>{e=this.stop().then(()=>{this.resize(),this.resume()})},50)}),setInterval(()=>{o.innerHTML=`\n        scale: ${this.scale.toFixed(2)}<br>\n        fps: ${this.dt.fps}\n      `},500),this.resize()}async start({dimension:t,scene:e}){this.paused=!1,t&&(this.dimension=t),e&&(this.scene=e),await this.workerPool.broadcast("start",{dimension:this.dimension,scene:this.scene}),this.dt.reset(),this.currentFrame=this.draw()}async stop(){this.paused=!0,await this.currentFrame}resume(){this.paused=!1,this.currentFrame=this.draw()}async draw(){if(!this.dt.onTarget()){let t=Math.sqrt(this.dt.differenceTarget());const e=Math.min(Math.max(this.scale*t,.1),2,devicePixelRatio);await this.resize(e)}this.dt.start();let t=Math.atan2(this.camPos[1],this.camPos[0]),e=h*this.dt.dtSec(18);this.camPos[0]=8*Math.cos(t+e),this.camPos[1]=8*Math.sin(t+e),this.camPos[2]=d(3,this.camPos[2],8,this.dt.dtSec(8)),this.camPos[3]=d(4,this.camPos[3],8,this.dt.dtSec(8)),this.camPos[4]=d(5,this.camPos[4],8,this.dt.dtSec(8)),this.camPos[5]=d(6,this.camPos[5],8,this.dt.dtSec(8)),this.camPos[6]=d(7,this.camPos[6],8,this.dt.dtSec(8)),this.camPos[7]=d(8,this.camPos[7],8,this.dt.dtSec(8)),this.camPos[8]=d(9,this.camPos[8],8,this.dt.dtSec(8));let s=6*this.workerPool.size(),i=Math.max(9*Math.ceil(this.canvas.height/s/9),27),n=Math.ceil(this.canvas.height/i),a=[];for(var r=0;r<n;r++){let t=i*r,e=Math.min(t+i,this.canvas.height),s=this.imageData[r]||this.ctx.getImageData(0,t,this.canvas.width,e-t);a.push(this.workerPool.schedule("update",{data:s.data,camPos:this.camPos,start:t,end:e,width:this.canvas.width,height:this.canvas.height,dimension:this.dimension}))}const o=await Promise.all(a);await new Promise(requestAnimationFrame),o.forEach((t,e)=>{const s=new ImageData(t,this.canvas.width);this.ctx.putImageData(s,0,i*e),this.imageData[e]=s}),this.dt.end(),this.paused||(this.currentFrame=this.draw())}resize(t){if(t){if(t===this.scale)return;this.scale=t}const e=document.getElementById("wrapper"),s=9*Math.ceil(e.clientWidth*this.scale/9),i=9*Math.ceil(e.clientHeight*this.scale/9),n=Math.max(e.clientWidth/s,e.clientHeight/i);this.canvas.style.transform=`scale(${n})`,this.canvas.style.transformOrigin="top left",this.canvas.width=s,this.canvas.height=i,this.dt.reset(),this.imageData=[],console.log(`rescale: ${this.scale.toFixed(2)}, canvas: ${s} ${i}`)}};async function u(){const t=r.value,e=Math.max(Math.min(parseInt(a.value,10),9),2);await l.stop(),await l.start({dimension:e,scene:t})}a.addEventListener("change",u),r.addEventListener("change",u),u()}]);