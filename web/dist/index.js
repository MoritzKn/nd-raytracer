!function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t){let e=8;navigator.hardwareConcurrency&&(e=navigator.hardwareConcurrency),this.pool=[];for(var s=0;s<e;s++){const e=new Worker(t);e.jobs=0,this.pool.push(e)}this.msgId=0,this.pending=[],console.log(`Created ${e} workers`)}size(){return this.pool.length}broadcast(t,e){return Promise.all(this.pool.map(s=>this.send(s,t,e)))}send(t,e,s){this.msgId+=1;const i=this.msgId;let a=[];return s&&s.data&&s.data.buffer&&a.push(s.data.buffer),t.jobs+=1,t.postMessage({type:e,data:s,id:i},a),new Promise((e,s)=>{const a=n=>{const{type:r,id:o,data:h,error:c}=n.data;o===i&&(t.removeEventListener("message",a),t.jobs-=1,this.runPendingJobs(),c?s(c):e(h))};t.addEventListener("message",a)})}runPendingJobs(){this.pool.forEach(t=>{if(0===t.jobs&&this.pending.length>0){const e=this.pending.pop();this.send(t,e.type,e.data).then(e.resolve,e.reject)}})}schedule(t,e){let s,i;const a=new Promise((function(t,e){s=t,i=e}));return this.pending.push({type:t,data:e,resolve:s,reject:i}),this.runPendingJobs(),a}}class a{constructor(){this.targetDt=1e3/24,this.dt=this.targetDt,this.avgDt=null,this.frameStart=null,this.lastReset=0}start(){this.frameStart=performance.now()}end(){this.dt=performance.now()-this.frameStart,null!==this.avgDt?this.avgDt=(60*this.avgDt+this.dt)/61:this.lastReset>0&&(this.avgDt=this.dt),this.lastReset+=1}differenceTarget(){return null!==this.avgDt?this.targetDt/this.avgDt:1}onTarget(){let t;t=this.lastReset<60?.6:.3;return Math.abs(1-this.differenceTarget())<t}resetAvg(){this.avgDt=null,this.lastReset=0}dtSec(t){return this.dt/1e3/t}toString(){const t=this.avgDt||this.dt;return`${this.dt.toFixed(2)}ms (avg: ${t.toFixed(2)}ms)`}}const n=2*Math.PI;function r(t,e){return[Math.cos(t)*e,Math.sin(t)*e]}const o=[];function h(t,e,s,i,a=0){e-=a;const n=o[t]||(Math.random()<.5?1:-1),r=.5*s;(e+=n*s*i)>r&&(e=r-(e-r),o[t]=-n);const h=-.5*s;return e<h&&(e=h-(e-h),o[t]=-n),e+=a}const c=new class{constructor(){this.canvas=document.getElementById("canvas"),this.ctx=canvas.getContext("2d"),this.workerPool=new i("worker.js"),this.dt=new a,this.camPos=[8,8,6,8,-3,-2,-1,0,1,2,3,4],this.dimension=4,this.scene="inital",this.scale=1,this.currentFrame=null,this.paused=!0;let t=null,e=null;window.addEventListener("resize",async()=>{await e,clearTimeout(t),t=setTimeout(()=>{e=this.stop().then(()=>{this.resize(),this.resume()})},50)}),this.resize()}async start({dimension:t,scene:e}){this.paused=!1,t&&(this.dimension=t),e&&(this.scene=e),await this.workerPool.broadcast("start",{dimension:this.dimension,scene:this.scene}),this.dt.resetAvg(),this.currentFrame=this.draw()}async stop(){this.paused=!0,await this.currentFrame}resume(){this.paused=!1,this.currentFrame=this.draw()}async draw(){if(!this.dt.onTarget()){let t=Math.sqrt(this.dt.differenceTarget());const e=Math.min(Math.max(this.scale*t,.1),2);await this.resize(e)}this.dt.start();let t=Math.atan2(this.camPos[1],this.camPos[0]);this.camPos=[...r(t+n*this.dt.dtSec(18),8),h(0,this.camPos[2],8,this.dt.dtSec(6)),h(1,this.camPos[3],8,this.dt.dtSec(9)),h(2,this.camPos[4],8,this.dt.dtSec(6.5)),h(3,this.camPos[5],8,this.dt.dtSec(5.5)),h(4,this.camPos[6],8,this.dt.dtSec(5.25)),h(5,this.camPos[7],8,this.dt.dtSec(5)),h(6,this.camPos[8],8,this.dt.dtSec(4.75))];let e=2*this.workerPool.size(),s=[],i=27*Math.ceil(this.canvas.height/e/27);for(var a=0;a<e;a++){let t=i*a,e=Math.min(t+i,this.canvas.height),n=this.ctx.getImageData(0,t,this.canvas.width,e);s.push(this.workerPool.schedule("update",{data:n.data,camPos:this.camPos,start:t,end:e,width:this.canvas.width,height:this.canvas.height,dimension:this.dimension}))}const o=await Promise.all(s);this.dt.end(),await new Promise(t=>{requestAnimationFrame(t)}),o.forEach((t,e)=>{const s=new ImageData(t,this.canvas.width);this.ctx.putImageData(s,0,i*e)}),console.log(`update dt: ${this.dt}, scale: ${this.scale.toFixed(2)}`),this.paused||(this.currentFrame=this.draw())}resize(t){if(t){if(t===this.scale)return;this.scale=t}const e=document.getElementById("wrapper"),s=27*Math.ceil(e.clientWidth*this.scale/27),i=27*Math.ceil(e.clientHeight*this.scale/27);let a=Math.max(e.clientWidth/s,e.clientHeight/i);this.canvas.style.transform=`scale(${Math.max(a+.01,1)})`,this.canvas.style.transformOrigin="center",this.canvas.width=s,this.canvas.height=i,this.dt.resetAvg(),console.log(`rescale: ${this.scale.toFixed(2)}, canvas: ${s} ${i}`)}};async function d(){const t=u.value,e=Math.max(Math.min(parseInt(l.value,10),9),2);await c.stop(),await c.start({dimension:e,scene:t})}const l=document.getElementById("dimension"),u=document.getElementById("scene");l.addEventListener("change",d),u.addEventListener("change",d),d()}]);